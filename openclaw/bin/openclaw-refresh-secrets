#!/bin/bash
# Refresh OpenClaw secrets cache from 1Password.
# Run this over SSH or interactively when op read works.
# Usage: ssh dylans-mac-mini ~/bin/openclaw-refresh-secrets
set -euo pipefail

export HOME="/Users/dbochman"
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"
export OP_SERVICE_ACCOUNT_TOKEN=$(cat "$HOME/.openclaw/.env-token")

CACHE="$HOME/.openclaw/.secrets-cache"
TMP=$(mktemp)

echo "Fetching secrets from 1Password..."
{
  echo "OPENAI_API_KEY=$(/opt/homebrew/bin/op read 'op://OpenClaw/OpenAI API Key/password')"
  echo "ELEVENLABS_API_KEY=$(/opt/homebrew/bin/op read 'op://OpenClaw/ElevenLabs API Key/password')"
  echo "OPENCLAW_GATEWAY_TOKEN=$(/opt/homebrew/bin/op read 'op://OpenClaw/OpenClaw Gateway Token/password')"
  echo "GOG_KEYRING_PASSWORD=$(/opt/homebrew/bin/op read 'op://OpenClaw/GOG CLI/password')"
} > "$TMP"

mv "$TMP" "$CACHE"
chmod 600 "$CACHE"
echo "Secrets cached to $CACHE ($(wc -c < "$CACHE") bytes)"
echo "Restart the gateway to pick up changes: launchctl stop ai.openclaw.gateway && launchctl start ai.openclaw.gateway"
