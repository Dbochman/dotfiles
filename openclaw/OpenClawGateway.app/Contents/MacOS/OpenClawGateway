#!/bin/bash

export HOME="/Users/dbochman"
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"

# Use 1Password service account (works headlessly in launchd)
export OP_SERVICE_ACCOUNT_TOKEN=$(cat "$HOME/.openclaw/.env-token")

# Read secrets from 1Password at startup â€” no plaintext caching
_secret() {
  local op_path="$1"
  /opt/homebrew/bin/op read "$op_path" 2>/dev/null
}

export OPENAI_API_KEY=$(_secret "op://OpenClaw/OpenAI API Key/password")
export ELEVENLABS_API_KEY=$(_secret "op://OpenClaw/ElevenLabs API Key/password")
export OPENCLAW_GATEWAY_TOKEN=$(_secret "op://OpenClaw/OpenClaw Gateway Token/password")
export GOG_KEYRING_PASSWORD=$(_secret "op://OpenClaw/GOG CLI/password")

# Verify critical secrets loaded
if [[ -z "$OPENCLAW_GATEWAY_TOKEN" ]]; then
  echo "FATAL: Failed to read gateway token from 1Password" >&2
  exit 1
fi

exec /opt/homebrew/Cellar/node@22/22.22.0/bin/node /opt/homebrew/lib/node_modules/openclaw/dist/index.js gateway --port 18789
